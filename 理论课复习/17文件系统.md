# 文件系统

```
行百里者半九十。
																					——wzk
```



## 目录

```
基本概念
实现方法
实例分析
```



##  索引与重点

内存空间：有限、易失、难以共享

### 基本概念

**文件**P3：具有文件名的一组相关信息的集合。实质上是字节序列，IO设备也可看做文件。

文件包括文件体和文件说明

用户使用逻辑文件，OS管理物理文件

文件系统P4：管理磁盘、实现文件按名存取、文件信息共享保护、提供用户接口、提高性能、提供IO统一接口

文件系统层次P5：文件系统接口（命令行接口、程序接口）、对象操作管理的软件集合、对象及其属性（文件、目录、磁盘存储空间）

**文件名**P6

**文件类型**P7：用途、数据、保护级别、逻辑结构、物理结构

**文件逻辑结构**：记录式（记录）、流式（字节）、树形

存取方式：顺序读取、随机读取

存储介质：物理块为单位

文件基本操作P9

**目录作用**P10：迅速定位文件，命名方便用户（重名、别名）、提供分组功能

**目录：由文件说明索引组成的、用于文件检索的特殊文件。**

**目录内容**P12：文件访问和控制的信息。基本信息（文件名）、文件类型（结构、内容、用途、属性、文件组织、地址信息、访问控制信息、使用信息）

目录操作P13

单级目录P14：结构简单，检索时间长，有命名冲突，不易于共享

两级目录P15：根目录——用户目录

多级目录P15：层次清楚、解决重名问题、查找速度快。目录多时路径检索时间长

### 实现方法

**文件控制块**P19：基本信息、访问控制信息、使用信息

文件描述符：非负整数，标识打开的文件

文件逻辑结构：提高检索效率、标语修改、降低存储代价

文件物理结构：存储介质上存放位置、链接、编目方法

**连续（顺序）结构**P21：简单易实现，顺序存取和随机存取效率高。容易出现磁盘碎片，文件大小不易改变，不利于文件动态增加修改。**适合于变化不大的文件**

**串联（链接）结构**P22：文件存在于若干块中，相互链接，每个块有一个或多个逻辑记录（也可以多个物理块包含一个逻辑记录）。空间利用率高，便于动态扩展，顺序存取效率高。随机存取效率很低，不可靠，指针占用空间。**适合于顺序访问**

**索引结构**P24：文件存在于物理块中，块号存放在索引表

索引文件P24：数据文件+索引表

访问索引文件两步操作：访问索引区（逻辑块号=>物理块号），访问物理块号

访问n级目录下的文件需要访存2n+1次（假设根节点inode已在内存中）

索引文件特点：可以顺序/随机读取，满足动态增长要求，充分利用外存空间。带来系统时间空间开销。

直接索引、间接索引P26

**目录实现方法**：直接（目录项=文件名+文件控制块）、间接（目录项=文件名+文件控制块地址）

长文件名P32

目录查询技术P33

**共享文件**：硬连接（两个inode保存相同的物理块号，不能针对目录创建，不能针对不存在的文件创建否则出现环路）、软连接（inode保存另一个inode的物理块号）

**保护文件**：建立副本P36（方法简单，开销大，适用于小而重要的文件）、定时转储P36、规定权限

一致性检查P37

存取控制P38

并发访问P39

性能问题P39：减少磁盘访问次数、磁盘碎片整理、磁盘调度、RAID、块高速缓存P40（哈希表+双向链表+LRU）等

块过大：读磁盘次数少，内碎片大浪费空间；块过小：磁盘空间利用率高，但读取磁盘次数多浪费时间

日志结构文件系统LFS P42



## 小测题

2. 以下哪项信息不能从超级块（super block）中读出（D）

A. 文件系统类型

B. 文件系统版本

C. 数据块大小

D. 文件逻辑块到物理块的映射信息



8. 下列对于文件进行 rename 操作的说法正确的有（）

A. 需要修改相应的目录项

B. 需要修改相应的文件控制块C. 可以把原文件 copy 到一个以新名字命名的文件，然后删除原文件来实现 rename

D. 答案 C 的方法因为改变了文件的创建时间信息，不符合 rename 的操作语义

【答案】A、B、D



2. 下列关于硬连接说法不正确的是（）

A. 不能针对不存在的文件创建硬连接

B. 如果允许对目录创建硬连接，可能造成目录层次结构中出现环路

C. 如果允许对目录创建硬连接，可能导致同样一个文件存在两个文件路径

D. 针对某文件创建一个硬连接文件，在其所在的目录中无需创建新的目录项

【答案】D



7. 基于日志结构的文件系统 LFS 解决了哪些问题（）

A. 写操作引起的磁头臂反复移动

B. inode 的分散管理

C. segment 的碎片化问题

D. 基于检查点的文件系统失效恢复【答案】A、B、C、D



相机、音乐播放器适合采取连续文件

文件控制块中不包括文件描述符